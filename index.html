<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ISC Command Network</title>

<!-- Firebase SDKs (Backend System) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0b0f1a;color:white}
header{background:#111827;padding:15px;text-align:center;font-size:22px;font-weight:bold}
nav{display:flex;justify-content:center;background:#1f2937;padding:10px;flex-wrap:wrap}
nav button{margin:5px;padding:8px 15px;border:none;border-radius:6px;background:#374151;color:white;cursor:pointer}
nav button:hover{background:#38bdf8;color:black}
.section{display:none;padding:20px;max-width:1000px;margin:auto}
.card{background:#1f2937;padding:20px;border-radius:10px;margin-bottom:20px}
input,textarea,select{width:100%;padding:8px;margin-bottom:10px;border-radius:6px;border:none}
button.primary{background:#38bdf8;color:black;font-weight:bold}
.chat-box{height:300px;overflow-y:auto;background:#111827;padding:10px;border-radius:8px;margin-bottom:10px}
.message{margin-bottom:6px}
.admin{color:#f87171}
.dispatch{color:#34d399}
</style>
</head>
<body>

<header>INTERSTELLAR SUPREME COUNCIL (ISC) COMMAND NETWORK</header>

<nav>
<button onclick="showSection('home')">Home</button>
<button onclick="showSection('distress')">Distress Signal</button>
<button onclick="showSection('contracts')">Submit Contract</button>
<button onclick="showSection('chat')">Global Chat</button>
<button id="contractServicesNav" onclick="showSection('contractServices')" style="display:none">Contract Services</button>
<button id="orgDashNav" onclick="showSection('orgDash')" style="display:none">Org Dashboard</button>
<button id="dispatchNav" onclick="showSection('dispatch')" style="display:none">Dispatch Panel</button>
<button onclick="showSection('account')">Account</button>
</nav>

<!-- HOME -->
<div id="home" class="section" style="display:block">
<div class="card">
<h2>Welcome to ISC Network</h2>
<p>This system supports public distress signals, contract management, federation structures, underground alliances, and Starfleet command priority routing.</p>
</div>
</div>

<!-- DISTRESS SIGNAL -->
<div id="distress" class="section">
<div class="card">
<h2>Send Distress Signal</h2>
<form onsubmit="sendDistress(event)">
<input type="text" id="ship" placeholder="Ship Amplifying Signal" required>
<select id="threat" required>
<option value="">Threat Level</option>
<option>Imminent</option>
<option>Moderate</option>
<option>Light</option>
</select>
<select id="injury" required>
<option value="">Injury Tier</option>
<option>Tier 1</option>
<option>Tier 2</option>
<option>Tier 3</option>
<option>Knocked Out</option>
</select>
<label><input type="checkbox" required> I understand I must accept responder friend request</label>
<button class="primary">Transmit Signal</button>
</form>
</div>
</div>

<!-- CONTRACTS -->
<div id="contracts" class="section">
<div class="card">
<h2>Submit Contract</h2>
<form onsubmit="submitContract(event)">
<input type="text" id="contractOrg" placeholder="Organization You're With" required>
<input type="text" id="contractType" placeholder="Type of Contract" required>
<textarea id="contractDetails" placeholder="Details" required></textarea>
<button class="primary">Submit Contract</button>
</form>
</div>
</div>

<!-- GLOBAL CHAT -->
<div id="chat" class="section">
<div class="card">
<h2>Global Chat</h2>
<div class="chat-box" id="chatBox"></div>
<input type="text" id="chatInput" placeholder="Type message">
<button onclick="sendMessage()" class="primary">Send</button>
</div>
</div>

<!-- CONTRACT SERVICES -->
<div id="contractServices" class="section">
  <div class="card">
    <h2>Contract Services Queue</h2>
    <p style="opacity:.85">Visible to Contract Service orgs (and Admin). Accept a contract to claim it.</p>
    <div id="csList"></div>
  </div>
</div>

<!-- ORG DASHBOARD -->
<div id="orgDash" class="section">
  <div class="card">
    <h2>Org Dashboard</h2>
    <p style="opacity:.85">Visible to Org Admins/Recruiters (and Admin). Verify new members, manage org roster, and assign org roles.</p>

    <h3 style="margin-top:18px">Pending Verifications</h3>
    <div id="pendingList"></div>

    <h3 style="margin-top:18px">Org Roster</h3>
    <div id="rosterList"></div>

    <div class="card" style="margin-top:18px;background:#111827">
      <h3>Org Settings</h3>
      <p style="opacity:.85">(Coming next) Set your org type: Federation / Underground / Individual Alliance / Contract Services, and manage alliance visibility rules.</p>
    </div>
  </div>
</div>

<!-- DISPATCH PANEL -->
<div id="dispatch" class="section">
<div class="card">
<h2>Starfleet Dispatch Panel</h2>
<p class="dispatch">Visible to Dispatch Role & Admin Only (role logic enforced via backend rules later)</p>

<h3>Incoming Distress Signals</h3>
<div id="dispatchSignals"></div>

<h3 style="margin-top:18px">Incoming Contracts</h3>
<div id="dispatchContracts"></div>

</div>
</div>

<!-- ACCOUNT -->
<div id="account" class="section">
<div class="card">
<h2>Create / Manage Account</h2>
<form onsubmit="createAccount(event)">
<input type="text" id="name" placeholder="Full Name" required>
<input type="text" id="handle" placeholder="SC Handlename" required>
<input type="text" id="org" placeholder="Organization" required>
<input type="number" id="age" placeholder="Age" required>
<input type="email" id="email" placeholder="Email" required>
<input type="text" id="rank" placeholder="Org Rank" required>
<input type="text" id="rsi" placeholder="RSI Citizen Dossier Link" required>
<button class="primary">Create Account</button>
</form>
</div>
</div>

<script>
// ðŸ”¥ YOU MUST REPLACE THIS WITH YOUR OWN FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

function showSection(id){
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='block';
}

let currentUser = null;
let currentProfile = null;

function escapeHtml(str){
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;');
}

function loginWithDiscord() {
  const provider = new firebase.auth.OAuthProvider('oidc.discord');
  auth.signInWithPopup(provider)
    .then(async (result) => {
      const user = result.user;
      const ref = db.collection('users').doc(user.uid);

      // IMPORTANT: Do NOT overwrite Admin/Dispatch roles on every login.
      // Only set defaults if the doc is new / fields are missing.
      await db.runTransaction(async (tx) => {
        const snap = await tx.get(ref);
        const existing = snap.exists ? (snap.data() || {}) : {};

        const updates = {
          uid: user.uid,
          updatedAt: Date.now(),
        };

        // Only set these if we actually have values (donâ€™t write null)
        if (user.displayName) updates.discordName = user.displayName;
        if (user.email) updates.email = user.email;
        if (user.photoURL) updates.photo = user.photoURL;

        // Defaults only if missing
        if (!('role' in existing)) updates.role = 'Member';
        if (!('orgRole' in existing)) updates.orgRole = 'Member';
        if (!('orgStatus' in existing)) updates.orgStatus = 'Unverified';
        if (!('createdAt' in existing)) updates.createdAt = Date.now();

        tx.set(ref, updates, { merge: true });
      });
    })
    .catch((error) => {
      console.error(error);
      alert("Discord login failed. Open F12 â†’ Console to see details.");
    });
}

function logout(){
  auth.signOut();
}

function requireLogin(){
  if(!currentUser){
    alert('Please Login with Discord first.');
    showSection('home');
    return false;
  }
  return true;
}

async function loadProfileAndGateUI(user){
  const who = document.getElementById('whoami');
  const dispatchNav = document.getElementById('dispatchNav');
  const orgDashNav = document.getElementById('orgDashNav');
  const contractServicesNav = document.getElementById('contractServicesNav');

  const snap = await db.collection('users').doc(user.uid).get();
  currentProfile = snap.exists ? snap.data() : null;

  const role = (currentProfile?.role || 'Member');
  const orgRole = (currentProfile?.orgRole || 'Member'); // Member | Recruiter | OrgAdmin
  const name = (currentProfile?.discordName || user.displayName || 'Unknown');

  who.textContent = `Logged in as: ${name} (Role: ${role} | OrgRole: ${orgRole})`;

  // Show Dispatch tab only for Dispatch/Admin
  dispatchNav.style.display = (role === 'Admin' || role === 'Dispatch') ? 'inline-block' : 'none';

  // Org Dashboard for OrgAdmin/Recruiter/Admin
  orgDashNav.style.display = (role === 'Admin' || orgRole === 'OrgAdmin' || orgRole === 'Recruiter') ? 'inline-block' : 'none';

  // Contract Services queue for ContractServices role OR Admin
  contractServicesNav.style.display = (role === 'Admin' || role === 'ContractServices') ? 'inline-block' : 'none';

  // Start / refresh listeners
  startChatListener();
  startOrgDashListeners();
  startDispatchListeners();
  startContractServicesListener();
}  (Role: ${role})`;
  dispatchNav.style.display = (role === 'Admin' || role === 'Dispatch') ? 'inline-block' : 'none';
}

auth.onAuthStateChanged(async (user) => {
  currentUser = user;
  currentProfile = null;

  const who = document.getElementById('whoami');
  const dispatchNav = document.getElementById('dispatchNav');

  if(!user){
    who.textContent = 'Not logged in';
    dispatchNav.style.display = 'none';
    return;
  }

  await loadProfileAndGateUI(user);
});

function sendMessage(){
  if(!requireLogin()) return;
  let msg=document.getElementById('chatInput').value;
  if(!msg) return;

  const fromName = currentProfile?.discordName || currentUser.displayName || 'Unknown';

  db.collection('globalChat').add({
    message: msg,
    fromUid: currentUser.uid,
    fromName,
    timestamp: Date.now()
  });

  document.getElementById('chatInput').value='';
}

function sendDistress(e){
  e.preventDefault();
  if(!requireLogin()) return;

  const autoName = currentProfile?.discordName || currentUser.displayName || 'Unknown';
  const autoOrg = currentProfile?.orgName || '(Unverified Org)';
  const autoHandle = currentProfile?.scHandle || '(Not set)';

  db.collection('distressSignals').add({
    requester: {
      uid: currentUser.uid,
      name: autoName,
      scHandle: autoHandle,
      org: autoOrg
    },
    ship: ship.value,
    threat: threat.value,
    injury: injury.value,
    status: "Pending Dispatch",
    routingStage: "dispatch", // dispatch -> starfleet -> federation -> public
    createdAt: Date.now(),
    updatedAt: Date.now()
  });

  alert("Distress Signal Sent to Dispatch");
}

function submitContract(e){
  e.preventDefault();
  if(!requireLogin()) return;

  const autoName = currentProfile?.discordName || currentUser.displayName || 'Unknown';

  db.collection('contracts').add({
    requesterName: autoName,
    org: contractOrg.value,
    type: contractType.value,
    details: contractDetails.value,
    status: "Pending Starfleet Dispatch",
    createdAt: Date.now(),
    updatedAt: Date.now()
  });

  alert("Contract Sent to Dispatch");
}

function createAccount(e){
  e.preventDefault();
  if(!requireLogin()) return;

  db.collection('users').doc(currentUser.uid).set({
    name: name.value,
    scHandle: handle.value,
    orgName: org.value,
    age: Number(age.value),
    email: email.value,
    orgRank: rank.value,
    rsi: rsi.value,
    orgStatus: "Pending",
    updatedAt: Date.now()
  }, { merge: true });

  alert("Profile submitted - awaiting Org verification/claim.");
}

// Live Chat Listener
// Live Chat Listener
let chatUnsub = null;
function startChatListener(){
  if(chatUnsub) return; // only once
  chatUnsub = db.collection('globalChat').orderBy('timestamp')
    .onSnapshot(snapshot=>{
      let box=document.getElementById('chatBox');
      if(!box) return;
      box.innerHTML='';
      snapshot.forEach(doc=>{
        const d = doc.data();
        const from = d.fromName || 'Unknown';
        box.innerHTML += `<div class='message'><b>${escapeHtml(from)}:</b> ${escapeHtml(d.message || '')}</div>`;
      });
      box.scrollTop = box.scrollHeight;
    });
}

// --- Org Dashboard (Verification + Roster) ---
let pendingUnsub = null;
let rosterUnsub = null;
function startOrgDashListeners(){
  if(!currentProfile) return;
  const orgName = currentProfile.orgName;
  if(!orgName) return;

  // Pending
  if(!pendingUnsub){
    pendingUnsub = db.collection('users')
      .where('orgName','==',orgName)
      .where('orgStatus','==','Pending')
      .onSnapshot(snap=>{
        const el = document.getElementById('pendingList');
        if(!el) return;
        if(snap.empty){ el.innerHTML = '<p style="opacity:.8">No pending members.</p>'; return; }
        let html='';
        snap.forEach(doc=>{
          const u = doc.data();
          html += `<div class='card' style='background:#111827'>
            <b>${escapeHtml(u.name || u.discordName || 'Unknown')}</b><br>
            <span style='opacity:.85'>Handle:</span> ${escapeHtml(u.scHandle || '(none)')}<br>
            <span style='opacity:.85'>Rank:</span> ${escapeHtml(u.orgRank || '(none)')}<br>
            <span style='opacity:.85'>RSI:</span> <a href='${escapeHtml(u.rsi || '#')}' target='_blank' style='color:#38bdf8'>Open dossier</a><br>
            <div style='margin-top:10px'>
              <button class='primary' onclick="approveMember('${doc.id}')">Approve</button>
              <button onclick="denyMember('${doc.id}')" style='margin-left:8px'>Deny</button>
              <select id='setOrgRole_${doc.id}' style='margin-top:10px'>
                <option value='Member'>Set OrgRole: Member</option>
                <option value='Recruiter'>Recruiter</option>
                <option value='OrgAdmin'>Org Admin</option>
              </select>
            </div>
          </div>`;
        });
        el.innerHTML = html;
      });
  }

  // Roster
  if(!rosterUnsub){
    rosterUnsub = db.collection('users')
      .where('orgName','==',orgName)
      .where('orgStatus','==','Verified')
      .onSnapshot(snap=>{
        const el = document.getElementById('rosterList');
        if(!el) return;
        if(snap.empty){ el.innerHTML = '<p style="opacity:.8">No verified members yet.</p>'; return; }
        let html='';
        snap.forEach(doc=>{
          const u = doc.data();
          html += `<div class='card' style='background:#111827'>
            <b>${escapeHtml(u.name || u.discordName || 'Unknown')}</b> <span style='opacity:.75'>(OrgRole: ${escapeHtml(u.orgRole || 'Member')})</span><br>
            <span style='opacity:.85'>Handle:</span> ${escapeHtml(u.scHandle || '(none)')}<br>
            <button onclick="kickMember('${doc.id}')" style='margin-top:10px'>Kick from Org</button>
          </div>`;
        });
        el.innerHTML = html;
      });
  }
}

async function approveMember(uid){
  if(!currentProfile) return;
  const sel = document.getElementById(`setOrgRole_${uid}`);
  const newOrgRole = sel ? sel.value : 'Member';
  await db.collection('users').doc(uid).set({
    orgStatus: 'Verified',
    orgRole: newOrgRole,
    updatedAt: Date.now()
  }, { merge:true });
}

async function denyMember(uid){
  await db.collection('users').doc(uid).set({
    orgStatus: 'Unverified',
    updatedAt: Date.now()
  }, { merge:true });
}

async function kickMember(uid){
  // Kick = remove from org and unverify
  await db.collection('users').doc(uid).set({
    orgStatus: 'Unverified',
    orgName: null,
    orgRole: 'Member',
    updatedAt: Date.now()
  }, { merge:true });
}

// --- Dispatch Panel (Signals + Contracts) ---
let dispatchSignalsUnsub = null;
let dispatchContractsUnsub = null;
function startDispatchListeners(){
  if(!currentProfile) return;
  const role = currentProfile.role || 'Member';
  if(!(role === 'Admin' || role === 'Dispatch')) return;

  if(!dispatchSignalsUnsub){
    dispatchSignalsUnsub = db.collection('distressSignals')
      .orderBy('createdAt','desc')
      .limit(25)
      .onSnapshot(snap=>{
        const el = document.getElementById('dispatchSignals');
        if(!el) return;
        if(snap.empty){ el.innerHTML = '<p style="opacity:.8">No signals.</p>'; return; }
        let html='';
        snap.forEach(doc=>{
          const s = doc.data();
          const r = s.requester || {};
          html += `<div class='card' style='background:#111827'>
            <b>${escapeHtml(r.name || 'Unknown')}</b> <span style='opacity:.75'>(${escapeHtml(r.org || '(org)')})</span><br>
            <span style='opacity:.85'>Ship:</span> ${escapeHtml(s.ship)}<br>
            <span style='opacity:.85'>Threat:</span> ${escapeHtml(s.threat)} | <span style='opacity:.85'>Injury:</span> ${escapeHtml(s.injury)}<br>
            <span style='opacity:.85'>Stage:</span> ${escapeHtml(s.routingStage || 'dispatch')} | <span style='opacity:.85'>Status:</span> ${escapeHtml(s.status || '')}<br>
            <div style='margin-top:10px'>
              <button class='primary' onclick="markSignalAccepted('${doc.id}')">Accept / Respond</button>
              <button onclick="escalateSignal('${doc.id}','starfleet')" style='margin-left:8px'>Escalate â†’ Starfleet</button>
              <button onclick="escalateSignal('${doc.id}','federation')" style='margin-left:8px'>Escalate â†’ Federation</button>
              <button onclick="escalateSignal('${doc.id}','public')" style='margin-left:8px'>Escalate â†’ Public</button>
            </div>
          </div>`;
        });
        el.innerHTML = html;
      });
  }

  if(!dispatchContractsUnsub){
    dispatchContractsUnsub = db.collection('contracts')
      .orderBy('createdAt','desc')
      .limit(25)
      .onSnapshot(snap=>{
        const el = document.getElementById('dispatchContracts');
        if(!el) return;
        if(snap.empty){ el.innerHTML = '<p style="opacity:.8">No contracts.</p>'; return; }
        let html='';
        snap.forEach(doc=>{
          const c = doc.data();
          html += `<div class='card' style='background:#111827'>
            <b>${escapeHtml(c.type || 'Contract')}</b> <span style='opacity:.75'>from ${escapeHtml(c.requesterName || 'Unknown')}</span><br>
            <span style='opacity:.85'>Org:</span> ${escapeHtml(c.org || '(org)')}<br>
            <span style='opacity:.85'>Status:</span> ${escapeHtml(c.status || 'Pending')}
            <div style='margin-top:10px'>
              <button class='primary' onclick="routeContract('${doc.id}','ContractServices')">Send â†’ Contract Services</button>
              <button onclick="routeContract('${doc.id}','Public')" style='margin-left:8px'>Send â†’ Public</button>
              <button onclick="routeContract('${doc.id}','Starfleet')" style='margin-left:8px'>Assign â†’ Starfleet</button>
            </div>
            <div style='margin-top:10px;opacity:.85'>${escapeHtml(c.details || '')}</div>
          </div>`;
        });
        el.innerHTML = html;
      });
  }
}

async function markSignalAccepted(id){
  await db.collection('distressSignals').doc(id).set({
    status: 'Accepted by Dispatch',
    acceptedByUid: currentUser.uid,
    acceptedByName: currentProfile?.discordName || currentUser.displayName || 'Dispatch',
    updatedAt: Date.now()
  }, { merge:true });
}

async function escalateSignal(id, stage){
  await db.collection('distressSignals').doc(id).set({
    routingStage: stage,
    status: `Escalated to ${stage}`,
    updatedAt: Date.now()
  }, { merge:true });
}

async function routeContract(id, route){
  let status = 'Pending';
  if(route === 'ContractServices') status = 'Open-CS';
  if(route === 'Public') status = 'Open-Public';
  if(route === 'Starfleet') status = 'Assigned-Starfleet';
  await db.collection('contracts').doc(id).set({
    route,
    status,
    updatedAt: Date.now()
  }, { merge:true });
}

// --- Contract Services Queue ---
let csUnsub = null;
function startContractServicesListener(){
  if(!currentProfile) return;
  const role = currentProfile.role || 'Member';
  if(!(role === 'Admin' || role === 'ContractServices')) return;

  if(csUnsub) return;
  csUnsub = db.collection('contracts')
    .where('status','==','Open-CS')
    .orderBy('createdAt','desc')
    .limit(50)
    .onSnapshot(snap=>{
      const el = document.getElementById('csList');
      if(!el) return;
      if(snap.empty){ el.innerHTML = '<p style="opacity:.8">No contracts in Contract Services queue.</p>'; return; }
      let html='';
      snap.forEach(doc=>{
        const c = doc.data();
        html += `<div class='card' style='background:#111827'>
          <b>${escapeHtml(c.type || 'Contract')}</b><br>
          <span style='opacity:.85'>Requester:</span> ${escapeHtml(c.requesterName || 'Unknown')}<br>
          <span style='opacity:.85'>Org:</span> ${escapeHtml(c.org || '(org)')}<br>
          <div style='margin-top:10px;opacity:.9'>${escapeHtml(c.details || '')}</div>
          <div style='margin-top:10px'>
            <button class='primary' onclick="acceptContract('${doc.id}')">Accept</button>
          </div>
        </div>`;
      });
      el.innerHTML = html;
    });
}

async function acceptContract(id){
  if(!requireLogin()) return;
  await db.collection('contracts').doc(id).set({
    status: 'Accepted',
    acceptedByUid: currentUser.uid,
    acceptedByName: currentProfile?.discordName || currentUser.displayName || 'Unknown',
    updatedAt: Date.now()
  }, { merge:true });
}


// NOTE: Your timed routing (2 min â†’ 1 min â†’ 1 min) needs server-side logic.
// Weâ€™ll implement that next (Cloud Functions) and lock permissions with Firestore Rules.
</script>

</body>
</html>
